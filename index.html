<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <style>
      .winner {
        border: 2px solid #018001;
      }

      .loser {
        border: 2px solid #8c0e0e;
      }
    </style>

    <title></title>
  </head>
  <body>
    <div class="container">
      <div id="chartContainer" style="margin-top: 25px; margin-left:70px;"></div>

      <div class="row">
        <div class="col-sm-6">
          <h4>Strategy 1 - Final value</h4>
          <table class="table table-bordered">
            <tbody id="table1">
            </tbody>
          </table>
        </div>
        <div class="col-sm-6">
          <h4>Strategy 2 - Final value</h4>
          <table class="table table-bordered">
            <tbody id="table2">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/quicksettings/latest/quicksettings.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.12.0/d3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dimple/2.3.0/dimple.latest.min.js"></script>

    <script type="text/javascript">
      let settingsPanel;
      let reinitDelayId;

      let times_run = 0;
      let times_crashed = 0;

      let final_values = {};

      function renderGraph(data, container_id){
        document.getElementById(container_id).innerHTML = "";
        var svg = dimple.newSvg('#' + container_id, 900, 500);

        var myChart = new dimple.chart(svg, data);
        myChart.setBounds(60, 30, 805, 405);
        myChart.addCategoryAxis("x", "Day");
        myChart.addMeasureAxis("y", "Value");
        myChart.addLegend(100, 6, 120, 200, "Right");

        var s = myChart.addSeries("Metric", dimple.plot.line);
        s.getTooltipText = function (e) {
          return [
            'Day: ' + e.x,
            e.aggField[0] + ': ' + e.y.toFixed(2)];
        }

        myChart.draw();
      }

      function renderTable(price, money, portfolio_value, total_value, days, container_id){
        let html = '';
        let data = [
          {label: 'Total Value', value: total_value.toFixed(2)},
          {label: 'Money', value: money.toFixed(2)},
          {label: 'Portfolio Value', value: portfolio_value.toFixed(2)},
          {label: 'Portfolio Profit', value: (money - settingsPanel.getValue("start_money")).toFixed(2)},
          {label: 'Final Price', value: price.toFixed(2)},
          {label: 'Day', value: days}
        ]
        data.forEach(function(element) {
          html += '<tr><td>'+element.label+'</td><td>'+element.value+'</td></tr>'
        });

        if ('2' in final_values){
          $("#table2").removeClass();
          $("#table1").removeClass();

          if (final_values['1'] > final_values['2']){
            $("#table1").addClass("winner");
            $("#table2").addClass("loser");
          } else if (final_values['1'] < final_values['2']){
            $("#table2").addClass("winner");
            $("#table1").addClass("loser");
          }
        }

        document.getElementById(container_id).innerHTML = html;
      }

      function generateRandomNumber(min, max){
          return Math.random() * (max - min) + min;
      };

      function dailyPriceAdjustment(day, price, yearly_interest) {
        let dailyFluctuation = price * 0.05 + 0.1;
        let dailyIncrease = yearly_interest ** (1/365) - 1;

        if(times_crashed > 0){
          dailyIncrease = 0;
        }

        let min_increase = -0.5 * dailyFluctuation + (price * dailyIncrease);
        let max_increase = 0.5 * dailyFluctuation + (price * dailyIncrease);
        if (day > 190) {
          console.log((price * (dailyIncrease-1)))
          console.log(min_increase)
          console.log(max_increase)
          console.log(generateRandomNumber(min_increase, max_increase))
          console.log('')
        }

        price += generateRandomNumber(min_increase, max_increase);
        if(price < 0) {
          price = 0;
        }

        if(times_crashed < 1 && day == settingsPanel.getValue("price_crash_at_day")){
          times_crashed += 1;
          price = price / 5;
        }
        return price;
      }

      function calculate_prices(){
        let days = settingsPanel.getValue("days");
        let price = settingsPanel.getValue("start_price");
        let yearly_interest = 10; // times (e.g. 3 -> 3x value in one year)
        let prices = [];

        for (i = 0; i < days; i++) {
          price = dailyPriceAdjustment(i, price, yearly_interest, times_crashed);
          prices.push(price);
        }
        return prices;
      }

      function calculate_data(id, prices, max_portfolio_percentage){
        let days = settingsPanel.getValue("days");

        let amount = settingsPanel.getValue("start_amount");
        let start_money = settingsPanel.getValue("start_money")
        let money = start_money;
        let price = prices[0];
        let portfolio_value = price * amount;
        let total_value = portfolio_value + money;
        let portfolio_profit = 0;

        let max_overflow_percentage = 20;

        let data = [];
        for (i = 0; i < days; i++) {
          price = prices[i];

          portfolio_value = price * amount;
          total_value = portfolio_value + money;
          portfolio_profit = money - start_money;

          let max_portfolio_value = (max_portfolio_percentage/100) * total_value;
          let diff = portfolio_value - max_portfolio_value * (1+max_overflow_percentage/100);
          if(diff > 0){
            let sale_amount = (portfolio_value - max_portfolio_value) / price;
            amount = amount - sale_amount;
            money = money + sale_amount * price;
          }

          if((i % 10 == 0 && days < 500) || i % 20 == 0){
            data.push({'Day': i, 'Value': price, 'Metric': 'Price'});
            //data.push({'Day': i, 'Value': money, 'Metric': 'Money - strategy ' + id});
            data.push({'Day': i, 'Value': portfolio_value, 'Metric': 'Portfolio Value - strategy ' + id});
            data.push({'Day': i, 'Value': portfolio_profit, 'Metric': 'Portfolio Profit - strategy ' + id});
            //data.push({'Day': i, 'Value': total_value, 'Metric': 'Total - strategy ' + id});
          }
        }

        final_values[id] = total_value;

        renderTable(price, money, portfolio_value, total_value, days, 'table' + id);
        return data;
      }

      function run(){
        times_crashed = 0;
        let prices = calculate_prices();
        let data = calculate_data('1', prices, settingsPanel.getValue("max_portfolio_percentage1"));
        data = data.concat(calculate_data('2', prices, settingsPanel.getValue("max_portfolio_percentage2")));

        renderGraph(data, 'chartContainer');
        times_run += 1;
      }

      function runDelayed() {
          clearTimeout(reinitDelayId);
          reinitDelayId = setTimeout(run, 200);
      }

      function main(){
        settingsPanel = QuickSettings.create(0, 0, "Settings (h to hide)");
        settingsPanel.setKey("h");
        settingsPanel.setGlobalChangeHandler(runDelayed);
        settingsPanel.addRange("days", 1, 365*2, 365, 1);
        settingsPanel.addRange("start_amount", 1, 10, 1, 1);
        settingsPanel.addRange("start_price", 1, 10, 1, 1);
        settingsPanel.addRange("start_money", 1, 500, 9, 1);

        settingsPanel.addRange("price_crash_at_day", -1, 365*2, -1, 1);

        settingsPanel.addRange("max_portfolio_percentage1", 1, 100, 20, 1);
        settingsPanel.addRange("max_portfolio_percentage2", 1, 100, 20, 1);

        settingsPanel.saveInLocalStorage("SETTINGS_STORAGE");

        run();
       }

       if (document.addEventListener) document.addEventListener("DOMContentLoaded", main, false);
       else if (document.attachEvent) document.attachEvent("onreadystatechange", main);
       else window.onload = autorun;
    </script>
  </body>
</html>
